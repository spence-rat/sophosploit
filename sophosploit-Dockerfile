FROM kalilinux/kali-rolling:latest

#Environment variable to make apache2 install noninteractive
ENV DEBIAN_FRONTEND=noninteractive

#Install all packages required
RUN apt-get update && \
    apt-get --force-yes -y install \
    autoconf \
    subversion\
    wget \
    nfs-common \
    rsh-client \
    whois \
    snmp \
    curl \
    vim \
    git \
    python3 \
    python3-pip \
    build-essential \
    zlib1g \
    zlib1g-dev \
    libpq-dev \
    libpq5 \
    libpcap-dev \
    libsqlite3-dev \
    libssl-dev \
    libreadline-dev \
    libxml2-dev \
    libxslt1-dev \
    libssl-dev \
    tzdata \
    net-tools \
    ruby \
    ruby-dev \
    postgresql \
    sqlite3 && \
    rm -rf /var/lib/apt/lists/* && rm -rf /var/cache/apt/*


#Configure git
RUN git config --global user.name "spence-rat" \
    && git config --global user.email "spence.rat@outlook.com"
RUN git clone https://github.com/spence-rat/social-engineer-toolkit.git/ /opt/set

#Place the answerfile for seautomate
COPY ./scripts/autosploit.py /opt/set/autosploit.py
RUN chmod +x /opt/set/autosploit.py

#Other Setup Files
COPY ./scripts/db.sql /tmp/
COPY ./scripts/init.sh /usr/local/bin/init.sh


#Install requirements for seautomate from set directory
WORKDIR /opt/set
RUN pip install -r requirements.txt

#Install setoolkit
RUN python3 setup.py install

#Change set.config file to work in current context
RUN sed -i '95 c\\APACHE_SERVER=OFF' /etc/setoolkit/set.config
RUN sed -i '103 c\\WEB_PORT=80' /etc/setoolkit/set.config
RUN sed -i '33 c \\METASPLOIT_PATH=/msf5' /etc/setoolkit/set.config


#Create web server directory & file for setoolkit/apache
RUN mkdir -p /var/www/html/
RUN touch /var/www/html/index.html

#Install metasploit framework version 6i
RUN mkdir /msf
WORKDIR /msf
RUN git clone https://github.com/rapid7/metasploit-framework.git /msf
RUN gem install bundler
RUN bundle install
RUN rm -rf .git

RUN /etc/init.d/postgresql start && su postgres -c "psql -f /tmp/db.sql"

COPY ./conf/database.yml /msf/config/

CMD "init.sh"